# Liftover Issue Examples

This document provides concrete examples of common liftover failures when converting hg19 → hg38 coordinates, based on real data from chr1 positions in the 1KG.EAS dataset.

## Overview

The examples below were generated by:
1. Extracting chr1 positions from `1KG.EAS.auto.snp.norm.nodup.split.rare002.common015.missing.bim` (97,655 positions)
2. Filtering to regions of interest to ensure examples for all issue types (1,151 positions tested)
3. Running liftover using `liftOver` and `hg19ToHg38.over.chain.gz`
4. Analyzing failures and categorizing them by issue type
5. Finding corresponding chain file records for each example

---

## Centromere and Gap Redefinition in hg38

**Description**: hg38 significantly improved centromere modeling and gap placement. Variants near hg19 centromeres may fall into regions that were shifted or removed.

**Very common cause of failure in GWAS summary statistics.**

### Example from chr1

**Chain record before**: `chain 7406387 chr1 249250621 + 103785265 103863906 chr1 248956422 + 103382376 103461016 877`  
**Chain record after**: `chain 2247 chr1 249250621 + 120681253 120681278 chr1 248956422 + 148754254 148754279 2163699`

Failed position (in gap between chains):
- hg19 chr1:120,659,468 (SNP: 1:120659468:G:T, distance from centromere: ~875,966 bp) → FAILED (deleted)

**Key Observation**: The failed position falls in a gap between chain records, indicating this region was removed or significantly restructured in hg38. The chain records before and after show the boundaries of the gap.

---

## Ambiguous Mapping (Segmental Duplications)

**Description**: hg38 better represents segmental duplications. An hg19 coordinate may map to multiple hg38 loci, and liftover tools may discard multi-mapping variants.

**Common examples**: Immune gene clusters (HLA), Olfactory receptor regions, Subtelomeric segments

### Example from chr1

**Chain record before**: `chain 50767 chr1 249250621 + 1582861 1584456 chr1 248956422 + 1714655 1716246 1032141`  
**Chain record after**: `chain 13696 chr1 249250621 + 12822162 12822307 chr1 248956422 + 12762227 12762372 5498870`

Failed position (in gap between chains):
- hg19 chr1:1,590,526 (SNP: 1:1590526:G:C) → FAILED (deleted)

**Key Observation**: This position falls in a large gap (between position 1,584,456 and 12,822,162) in the chain file, indicating a region with complex segmental duplications and ambiguous mappings that were excluded from the chain file.

---

## Many-to-One Mappings

**Description**: Multiple hg19 positions may liftover to the same hg38 position. This is expected and reflects real assembly differences (collapsed regions, indels, etc.).

### Example from chr1

**hg38 chr1:149,077,786** ← 2 hg19 positions:

- hg19 chr1:144,619,516 (SNP: 1:144619516:G:A) → hg38 chr1:149,077,786
- hg19 chr1:148,342,373 (SNP: 1:148342373:C:T) → hg38 chr1:149,077,786

**hg38 position chain record(s)**:
- `chain 20851231461 chr1 249250621 + 10000 249240621 chr1 248956422 + 10000 248946422 2`
- `chain 4430836 chr1 249250621 + 143644525 144223871 chr1 248956422 + 148359880 149554357 487`


---

## Cross-Chromosome Mappings

**Description**: Some hg19 positions map to different chromosomes in hg38. This occurs due to assembly corrections, resolution of misassemblies, better representation of segmental duplications, and chromosomal rearrangements that were corrected in hg38.

**Important**: These are **valid mappings** - the sequence correspondence is correct, but the chromosome assignment changed between builds.

### Example from chr1

**Chain record**: `chain 2149 chr1 249250621 + 249058895 249058951 chr12 133275309 - 75188 75244 4960107`

- hg19 chr1:249,058,896 (SNP: 1:249058896:T:C) → hg38 chr12:133,200,121

**Key Observation**: This position maps from chr1 to chr12, indicating a significant assembly correction. Always check chromosome assignments after liftover and validate that the sequence correspondence makes biological sense.

---

## Running the Analysis

To generate these examples yourself:

```bash
cd /home/yunye/work/github/GWASTutorial/37_liftover
python3 liftover_from_bim.py
```

This will:
1. Extract chr1 positions from the BIM file
2. Filter to regions of interest
3. Run liftover
4. Analyze results and find chain records
5. Generate `liftover_bim_analysis.txt` with all examples

### Liftover Parameters

The analysis uses UCSC `liftOver` with the following command and parameters:

```bash
liftOver input.bed hg19ToHg38.over.chain.gz output.bed unmapped.bed
```

**Parameters used:**
- **Chain file**: `hg19ToHg38.over.chain.gz` (UCSC chain file for hg19 → hg38 conversion)
- **Default settings** (no explicit flags):
  - `minMatch=0.95` (minimum match ratio for intervals, default)
  - `multiple=0` (don't allow multiple mappings, default)
- **Input format**: BED format (0-based, half-open intervals)
- **Output**: 
  - Successfully lifted positions → `output.bed`
  - Failed positions → `unmapped.bed`

## Output Files

- `bim_chr1_positions_hg19.bed`: Input positions in hg19 (BED format with SNP IDs)
- `bim_chr1_positions_hg38.bed`: Successfully lifted positions
- `bim_chr1_positions_unmapped.bed`: Failed positions with failure reasons
- `liftover_bim_analysis.txt`: Detailed analysis with chain records for each example

## References

See `README.md` for detailed explanations of each issue type and the underlying mechanisms.
